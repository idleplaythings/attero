{% extends "::base.html.twig" %}

{% block body %}
    <div class="menubar top">
        <table>
            <tr>
                <td class="left">

                </td>
                <td class="center">
                    <h2>MAP EDITOR</h2><span id="mapname">Unnamed</span><span id="savestatus">(Unsaved)</span>
                </td>
                <td class="right">
                    {% image '@AtteroGameBundle/Resources/public/images/loadicon.png' %}
                        <div class="icon" id="loadicon" style="background-image:url({{ asset_url }})"></div>
                    {% endimage %}
                    {% image '@AtteroGameBundle/Resources/public/images/saveicon.png' %}
                        <div class="icon" id="saveicon" style="background-image:url({{ asset_url }})"></div>
                    {% endimage %}
                    {% image '@AtteroGameBundle/Resources/public/images/menuicon.png' %}
                        <div class="icon" id="settingsicon" style="background-image:url({{ asset_url }})"></div>
                    {% endimage %}
                </td>
            </tr>
        </table>
    </div>
    <!-- <canvas id="testcanvas" width="40" height="40" style="position:absolute;z-index:200;border:1px solid white;"></canvas> -->
    <div id="texturecontainer"></div>
    <div class="menubar bottom"></div>
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets '@AtteroGameBundle/Resources/public/css/*.css' %}
        <link rel="stylesheet" href="{{ asset_url }}" />
    {% endstylesheets %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

    {% javascripts
        '@AtteroGameBundle/Resources/public/js/requestAnimFrame.js'
        '@AtteroGameBundle/Resources/public/js/ResourceLoader.js'
        '@AtteroGameBundle/Resources/public/js/Loadable.js'
        '@AtteroGameBundle/Resources/public/js/Tile.js'
        '@AtteroGameBundle/Resources/public/js/GameTile.js'
        '@AtteroGameBundle/Resources/public/js/TileGrid.js'
        '@AtteroGameBundle/Resources/public/js/Texture.js'
        '@AtteroGameBundle/Resources/public/js/Three.js'
        '@AtteroGameBundle/Resources/public/js/Graphics.js'
        '@AtteroGameBundle/Resources/public/js/Scrolling.js'
        '@AtteroGameBundle/Resources/public/js/MouseWheel.js'
        '@AtteroGameBundle/Resources/public/js/Zooming.js'
        '@AtteroGameBundle/Resources/public/js/Landscaping.js'
        '@AtteroGameBundle/Resources/public/js/SideSlideMenu.js'
        '@AtteroGameBundle/Resources/public/js/TileElement.js'
        '@AtteroGameBundle/Resources/public/js/ImageManipulation.js'
        '@AtteroGameBundle/Resources/public/js/WaterLayer.js'
        '@AtteroGameBundle/Resources/public/js/Grid.js'
        '@AtteroGameBundle/Resources/public/js/FogOfWar.js'
        '@AtteroGameBundle/Resources/public/js/game/UIEvents.js'
        '@AtteroGameBundle/Resources/public/js/ContourShadowDefinitions.js'
        '@AtteroGameBundle/Resources/public/js/confirm.js'
        '@AtteroGameBundle/Resources/public/js/SaveLoad.js'
        '@AtteroGameBundle/Resources/public/js/Unit.js'
        '@AtteroGameBundle/Resources/public/js/MathLib.js'
        '@AtteroGameBundle/Resources/public/js/FogOfWar.js'
        '@AtteroGameBundle/Resources/public/js/LineOfSight.js'
        '@AtteroGameBundle/Resources/public/js/Raytrace.js'
        '@AtteroGameBundle/Resources/public/js/UnitManager.js'
        '@AtteroGameBundle/Resources/public/js/ServerConnection.js'
        '@AtteroGameBundle/Resources/public/js/MoveOrder.js'
    %}
        <script type="text/javascript" src="{{ asset_url }}"></script>
    {% endjavascripts %}

        <script>
            function dynamicResourcesLoaded()
            {

                Graphics.init();
                Graphics.animate();
                WaterLayer.init();
                Grid.init();
                FogOfWar.init();

                jQuery(".webglCanvas").on("click", TileGrid.onGridClicked);

                jQuery(".webglCanvas").on("mousedown", Scrolling.mousedown);
                jQuery(".webglCanvas").on("mouseup", Scrolling.mouseup);
                jQuery(".webglCanvas").on("mouseout", Scrolling.mouseout);
                jQuery(".webglCanvas").on("mousemove", Scrolling.mousemove);

                MouseWheel.hookEvent(jQuery(".webglCanvas").get(0), 'mousewheel', Zooming.mouseWheel);

                UnitManager.createFromString("{{ units }}");

                ServerConnection.connect("http://dev.attero.local:9000/gameserver");

                ResourceLoader.remove();
            }


            function staticResourcesLoaded()
            {
                console.log("static loaded");
                TileGrid.width = 100;
                TileGrid.height = 100;
                var mapString = "{{ mapString }}";
                mapString = mapString.replace(/&quot;/g, '"');

                TileGrid.createFromJson(JSON.parse(mapString));
                console.log("tiles created");
                ResourceLoader.loadTiles(dynamicResourcesLoaded);
            }

        </script>

        <script id="fogvertexShader" type="x-shader/x-vertex">
            varying vec2 vUv;

            void main() {
                vUv = uv;

                gl_Position =   projectionMatrix *
                                modelViewMatrix *
                                vec4(position,1.0);
            }
        </script>

        <script id="fogfragmentShader2" type="x-shader/x-fragment">
            uniform float xStep;
            uniform float yStep;
            uniform sampler2D tilemap;

            varying vec2 vUv;

            void main() {
                vec4 tile = texture2D(tilemap, vUv);

                if(tile.b == 0.0) { discard; }

                float oAlpha = tile.b;
                float alpha = tile.b;

                gl_FragColor = vec4(0.0, 0.0, 0.0, alpha);

            }
        </script>


        <script id="fogfragmentShader" type="x-shader/x-fragment">
            uniform sampler2D fogtexture;
            uniform float tilewidth;
            uniform float tileheight;
            uniform sampler2D tilemap;
            uniform float opacity;

            varying vec2 vUv;

            float texcount = 4.0;
            float texsize = 0.25;


            void main() {
                vec4 tile = texture2D(tilemap, vUv);

                if(tile.x == 1.0 && tile.y == 1.0) { discard; }

                float x = vUv.x/tilewidth;
                x -= floor(x);
                x /= texcount;
                x += tile.x*255.0*texsize;

                float y = vUv.y / tileheight;
                y -= floor(y);
                y /= texcount;
                y += tile.y*255.0*texsize;

                vec2 v = vec2(x, y);
                gl_FragColor = texture2D(fogtexture, v);
            }
        </script>

        <script id="vertexShader" type="x-shader/x-vertex">
            varying vec2 vUv;

            void main() {
                vUv = uv;

                gl_Position =   projectionMatrix *
                                modelViewMatrix *
                                vec4(position,1.0);
            }
        </script>

        <script id="fragmentShader" type="x-shader/x-fragment">
            uniform sampler2D texture;

            varying vec2 vUv;

            void main() {
                vec4 color = texture2D(texture, vUv);
                //color.a *= 0.5;
                gl_FragColor = color;
                //gl_FragColor = texture2D(tilemap, vUv);
            }
        </script>
{% endblock %}
